{-# LANGUAGE CPP, ForeignFunctionInterface, CApiFFI #-}
{-# LANGUAGE TypeSynonymInstances, FlexibleInstances #-}
{-# OPTIONS_GHC -Wall -fno-warn-unused-binds -fno-warn-unused-matches -Werror #-}

-- User level Haskell interface for TCL
-- Users of this module should not need to understand the tcl
-- implementation underneath this module
--
-- Ed Czeck, Bluespec Inc
-- April 2007


{-
  TODO
   - I do not like the error handling, via the Maybe type, but some may not want to throw errors
   - options processing (getOptions :: TclInterp -> [TclObj] -> [OptionDesc a] -> IO (a, [TclObj])
   - add import for Tcl_Eval
-}

module HTcl
    (
     -- Status return values, and an enum
     htcl_OK
    ,htcl_Error
    ,TclStatus

    ,TclObjCvt(..)
    ,TclInterp
    ,TclObj
    -----------------------
    -- Registering command and other command
    --  Types for command objects
    ,TclObjCmdProc
    ,TclCmdDeleteProc
    ,TclClientData
    ,htclRawFnToTclCmd
    ,htclFnToTclCmd
    ,htclCheckCmd
    ,htclMakeCmdDesc
    ,HTclCmdDesc(..)
    ,HTclCmdElem(..)
    ,HTclArgType(..)
    ,HTclCmdGrammar(..)
    ,HTclCmdFn
    ,HTclCheckedCmdFn
    ,htclRegisterCommand
    ,htclRegisterCommandFull
    ,htclRegCommands
    ,htclCmdName
    ,htclFirstCmdElem
    ,htclDescribeCmdGrammar
    ,htclGrammarShortDesc
    ,htclMatchGrammar
    ,htclCanMatchNull
    ,htclSetReturnVal           -- may not be needed
    -- Dealing with Errors
    ,htcl_AddObjErrorInfo
    ,htclErrorCatcher
    -------------------------------
    -- Converting from Obj to Native Haskell types
    ,htclArgsToTcl
    -- primitives
    ,htclObjToInt
    ,htclObjToBool
    ,htclObjToDouble
    ,htclObjToString
    ,htclObjToList
    -- composite
    ,htclObjToListInt
    ,htclObjToListDouble
    ,htclObjToListString
    -------------------------------
    ,HTclObj(..)
    -- Conversion to from objects to fields of this type
    ,HTclObjCvt(..)
    ,tag
    ,tagStr
    ,tagInt
    ,tagLst
    ,tagManyStr
    ,tagManyInt
    ,joinHTObj
    ,joinHTObjs
    -----------------
    -- Grammar combinators
    , kw
    , tclcmd
    , arg
    , (.+.)
    , oneOf
    , optional
    , atLeast
    -----------------
    -- Tests and Experiments
    )
where

import Prelude

import Data.Word

import Foreign.Storable
import Foreign.Marshal.Alloc
import Foreign.Marshal.Array
import Foreign.Marshal.Utils
import Foreign.Ptr
import Foreign.C.Types
import Foreign.C.String
import Data.Time.Clock
import Data.Time.Clock.POSIX

import Foreign.ForeignPtr
import Foreign.ForeignPtr.Unsafe(unsafeForeignPtrToPtr)

import Control.Monad(foldM, mplus, msum, when)
import System.IO.Error
import System.Exit(ExitCode(..))
import Data.List(intersperse, nub, isPrefixOf)

import qualified Control.Exception as CE

--import Debug.Trace
traceCalls :: Bool
traceCalls = False


-- cast function
castE :: (Enum a, Enum b) => a -> b
castE = toEnum . fromEnum

castI :: (Integral a, Integral b) => a -> b
castI = fromIntegral

castD :: (RealFloat a, RealFloat b) => a -> b
castD = (uncurry encodeFloat) . decodeFloat

--------------------------------------------------------------------------------
-- Common TCL function status
-- Note break, continue are not (yet) defined


-- | Status of a TCL command
data TclStatus = TclOK | TclError
    deriving (Eq, Show, Enum)

tclOK :: TclStatus
tclOK = TclOK

tclError :: TclStatus
tclError = TclError

-- Get real values from tcl world -- there should be an easier way to do this for #defines!
foreign import capi "tcl.h value TCL_OK"
 htcl_OKc :: CInt
foreign import capi "tcl.h value TCL_ERROR"
 htcl_Errorc :: CInt


-- exported versions of tcl status using native haskell types
htcl_OK :: TclStatus
htcl_OK = TclOK

htcl_Error :: TclStatus
htcl_Error = TclError


--------------------------------------------------------------------------------

-- The interperter -- no need for a finalizer call here
data XTclInterp = XTclInterp
type TclInterp = Ptr XTclInterp

-- Client data structure
type TclClientData = Ptr Int


-- Types and functions to deal with     Tcl Objects
-- Wrapper for foreign (tcl objects)
-- Objects which are passed to and from commands
data {-# CTYPE "Tcl_Obj" #-} XTclObj = XTclObj
type PTclObj = Ptr XTclObj
type TclObj = ForeignPtr XTclObj
type PTclObjArray = Ptr PTclObj


-- Foreign import functions --     Objects
foreign import ccall "Tcl_NewIntObj"
 tcl_NewIntObj :: CInt -> IO (PTclObj)

foreign import ccall "Tcl_NewWideIntObj"
 tcl_NewWideIntObj :: CLLong -> IO (PTclObj) -- tcl uses long long

foreign import ccall "Tcl_NewDoubleObj"
 tcl_NewDoubleObj :: CDouble -> IO PTclObj -- tcl double

foreign import ccall "Tcl_NewStringObj"
 tcl_NewStringObj :: Ptr CChar -> CInt -> IO PTclObj

foreign import ccall "Tcl_NewListObj"
 tcl_NewListObj :: CInt -> Ptr PTclObj ->  IO PTclObj


---------------------------------------------------------------
-- Reference count on Objects
foreign import capi "tcl.h Tcl_DecrRefCount"
 tcl_DecrRefCount :: PTclObj -> IO ()

foreign import capi "tcl.h Tcl_IncrRefCount"
 tcl_IncrRefCount :: PTclObj -> IO ()

foreign import ccall "&htcl_finalizeTclObj"
  tcl_finalizeTclObj :: FunPtr (PTclObj -> IO ())

tclObjFinalizer :: FinalizerPtr XTclObj
tclObjFinalizer = tcl_finalizeTclObj

-- Function to wrap tcl object into finalizer
wrapPtrForExport :: PTclObj -> IO TclObj
wrapPtrForExport pobj = do
  tcl_IncrRefCount pobj
  fp <- newForeignPtr_  pobj
  addForeignPtrFinalizer tclObjFinalizer fp
  return fp

---------------------------------------------------------
-- A class to provide means to convert to tcl objects and
-- haskell objects
-- 2 members are defined, one to convert to Ptr XTclObj and the other to convert to
-- ForeignPtr XTclObj.  Only the later should be used externally
class TclObjCvt a  where
    toTclObj    :: a -> IO TclObj


-- an instance of TclObjCvt call for Unit
instance  TclObjCvt () where
    toTclObj i  = toTclObj ""

-- an instance of TclObjCvt call for Bool
instance  TclObjCvt Bool where
    toTclObj b  = tcl_NewIntObj (if b then 1 else 0) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Int
instance  TclObjCvt Int where
    toTclObj i  = tcl_NewIntObj (castI i) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Integer
-- use show since value can be greater than native representation
instance  TclObjCvt Integer where
    toTclObj i  = toTclObj (show i)
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































{-# LANGUAGE CPP, ForeignFunctionInterface, CApiFFI #-}
{-# LANGUAGE TypeSynonymInstances, FlexibleInstances #-}
{-# OPTIONS_GHC -Wall -fno-warn-unused-binds -fno-warn-unused-matches -Werror #-}

-- User level Haskell interface for TCL
-- Users of this module should not need to understand the tcl
-- implementation underneath this module
--
-- Ed Czeck, Bluespec Inc
-- April 2007


{-
  TODO
   - I do not like the error handling, via the Maybe type, but some may not want to throw errors
   - options processing (getOptions :: TclInterp -> [TclObj] -> [OptionDesc a] -> IO (a, [TclObj])
   - add import for Tcl_Eval
-}

module HTcl
    (
     -- Status return values, and an enum
     htcl_OK
    ,htcl_Error
    ,TclStatus

    ,TclObjCvt(..)
    ,TclInterp
    ,TclObj
    -----------------------
    -- Registering command and other command
    --  Types for command objects
    ,TclObjCmdProc
    ,TclCmdDeleteProc
    ,TclClientData
    ,htclRawFnToTclCmd
    ,htclFnToTclCmd
    ,htclCheckCmd
    ,htclMakeCmdDesc
    ,HTclCmdDesc(..)
    ,HTclCmdElem(..)
    ,HTclArgType(..)
    ,HTclCmdGrammar(..)
    ,HTclCmdFn
    ,HTclCheckedCmdFn
    ,htclRegisterCommand
    ,htclRegisterCommandFull
    ,htclRegCommands
    ,htclCmdName
    ,htclFirstCmdElem
    ,htclDescribeCmdGrammar
    ,htclGrammarShortDesc
    ,htclMatchGrammar
    ,htclCanMatchNull
    ,htclSetReturnVal           -- may not be needed
    -- Dealing with Errors
    ,htcl_AddObjErrorInfo
    ,htclErrorCatcher
    -------------------------------
    -- Converting from Obj to Native Haskell types
    ,htclArgsToTcl
    -- primitives
    ,htclObjToInt
    ,htclObjToBool
    ,htclObjToDouble
    ,htclObjToString
    ,htclObjToList
    -- composite
    ,htclObjToListInt
    ,htclObjToListDouble
    ,htclObjToListString
    -------------------------------
    ,HTclObj(..)
    -- Conversion to from objects to fields of this type
    ,HTclObjCvt(..)
    ,tag
    ,tagStr
    ,tagInt
    ,tagLst
    ,tagManyStr
    ,tagManyInt
    ,joinHTObj
    ,joinHTObjs
    -----------------
    -- Grammar combinators
    , kw
    , tclcmd
    , arg
    , (.+.)
    , oneOf
    , optional
    , atLeast
    -----------------
    -- Tests and Experiments
    )
where

import Prelude

import Data.Word

import Foreign.Storable
import Foreign.Marshal.Alloc
import Foreign.Marshal.Array
import Foreign.Marshal.Utils
import Foreign.Ptr
import Foreign.C.Types
import Foreign.C.String
import Data.Time.Clock
import Data.Time.Clock.POSIX

import Foreign.ForeignPtr
import Foreign.ForeignPtr.Unsafe(unsafeForeignPtrToPtr)

import Control.Monad(foldM, mplus, msum, when)
import System.IO.Error
import System.Exit(ExitCode(..))
import Data.List(intersperse, nub, isPrefixOf)

import qualified Control.Exception as CE

--import Debug.Trace
traceCalls :: Bool
traceCalls = False


-- cast function
castE :: (Enum a, Enum b) => a -> b
castE = toEnum . fromEnum

castI :: (Integral a, Integral b) => a -> b
castI = fromIntegral

castD :: (RealFloat a, RealFloat b) => a -> b
castD = (uncurry encodeFloat) . decodeFloat

--------------------------------------------------------------------------------
-- Common TCL function status
-- Note break, continue are not (yet) defined


-- | Status of a TCL command
data TclStatus = TclOK | TclError
    deriving (Eq, Show, Enum)

tclOK :: TclStatus
tclOK = TclOK

tclError :: TclStatus
tclError = TclError

-- Get real values from tcl world -- there should be an easier way to do this for #defines!
foreign import capi "tcl.h value TCL_OK"
 htcl_OKc :: CInt
foreign import capi "tcl.h value TCL_ERROR"
 htcl_Errorc :: CInt


-- exported versions of tcl status using native haskell types
htcl_OK :: TclStatus
htcl_OK = TclOK

htcl_Error :: TclStatus
htcl_Error = TclError


--------------------------------------------------------------------------------

-- The interperter -- no need for a finalizer call here
data XTclInterp = XTclInterp
type TclInterp = Ptr XTclInterp

-- Client data structure
type TclClientData = Ptr Int


-- Types and functions to deal with     Tcl Objects
-- Wrapper for foreign (tcl objects)
-- Objects which are passed to and from commands
data {-# CTYPE "Tcl_Obj" #-} XTclObj = XTclObj
type PTclObj = Ptr XTclObj
type TclObj = ForeignPtr XTclObj
type PTclObjArray = Ptr PTclObj


-- Foreign import functions --     Objects
foreign import ccall "Tcl_NewIntObj"
 tcl_NewIntObj :: CInt -> IO (PTclObj)

foreign import ccall "Tcl_NewWideIntObj"
 tcl_NewWideIntObj :: CLLong -> IO (PTclObj) -- tcl uses long long

foreign import ccall "Tcl_NewDoubleObj"
 tcl_NewDoubleObj :: CDouble -> IO PTclObj -- tcl double

foreign import ccall "Tcl_NewStringObj"
 tcl_NewStringObj :: Ptr CChar -> CInt -> IO PTclObj

foreign import ccall "Tcl_NewListObj"
 tcl_NewListObj :: CInt -> Ptr PTclObj ->  IO PTclObj


---------------------------------------------------------------
-- Reference count on Objects
foreign import capi "tcl.h Tcl_DecrRefCount"
 tcl_DecrRefCount :: PTclObj -> IO ()

foreign import capi "tcl.h Tcl_IncrRefCount"
 tcl_IncrRefCount :: PTclObj -> IO ()

foreign import ccall "&htcl_finalizeTclObj"
  tcl_finalizeTclObj :: FunPtr (PTclObj -> IO ())

tclObjFinalizer :: FinalizerPtr XTclObj
tclObjFinalizer = tcl_finalizeTclObj

-- Function to wrap tcl object into finalizer
wrapPtrForExport :: PTclObj -> IO TclObj
wrapPtrForExport pobj = do
  tcl_IncrRefCount pobj
  fp <- newForeignPtr_  pobj
  addForeignPtrFinalizer tclObjFinalizer fp
  return fp

---------------------------------------------------------
-- A class to provide means to convert to tcl objects and
-- haskell objects
-- 2 members are defined, one to convert to Ptr XTclObj and the other to convert to
-- ForeignPtr XTclObj.  Only the later should be used externally
class TclObjCvt a  where
    toTclObj    :: a -> IO TclObj


-- an instance of TclObjCvt call for Unit
instance  TclObjCvt () where
    toTclObj i  = toTclObj ""

-- an instance of TclObjCvt call for Bool
instance  TclObjCvt Bool where
    toTclObj b  = tcl_NewIntObj (if b then 1 else 0) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Int
instance  TclObjCvt Int where
    toTclObj i  = tcl_NewIntObj (castI i) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Integer
-- use show since value can be greater than native representation
instance  TclObjCvt Integer where
    toTclObj i  = toTclObj (show i)








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































{-# LANGUAGE CPP, ForeignFunctionInterface, CApiFFI #-}
{-# LANGUAGE TypeSynonymInstances, FlexibleInstances #-}
{-# OPTIONS_GHC -Wall -fno-warn-unused-binds -fno-warn-unused-matches -Werror #-}

-- User level Haskell interface for TCL
-- Users of this module should not need to understand the tcl
-- implementation underneath this module
--
-- Ed Czeck, Bluespec Inc
-- April 2007


{-
  TODO
   - I do not like the error handling, via the Maybe type, but some may not want to throw errors
   - options processing (getOptions :: TclInterp -> [TclObj] -> [OptionDesc a] -> IO (a, [TclObj])
   - add import for Tcl_Eval
-}

module HTcl
    (
     -- Status return values, and an enum
     htcl_OK
    ,htcl_Error
    ,TclStatus

    ,TclObjCvt(..)
    ,TclInterp
    ,TclObj
    -----------------------
    -- Registering command and other command
    --  Types for command objects
    ,TclObjCmdProc
    ,TclCmdDeleteProc
    ,TclClientData
    ,htclRawFnToTclCmd
    ,htclFnToTclCmd
    ,htclCheckCmd
    ,htclMakeCmdDesc
    ,HTclCmdDesc(..)
    ,HTclCmdElem(..)
    ,HTclArgType(..)
    ,HTclCmdGrammar(..)
    ,HTclCmdFn
    ,HTclCheckedCmdFn
    ,htclRegisterCommand
    ,htclRegisterCommandFull
    ,htclRegCommands
    ,htclCmdName
    ,htclFirstCmdElem
    ,htclDescribeCmdGrammar
    ,htclGrammarShortDesc
    ,htclMatchGrammar
    ,htclCanMatchNull
    ,htclSetReturnVal           -- may not be needed
    -- Dealing with Errors
    ,htcl_AddObjErrorInfo
    ,htclErrorCatcher
    -------------------------------
    -- Converting from Obj to Native Haskell types
    ,htclArgsToTcl
    -- primitives
    ,htclObjToInt
    ,htclObjToBool
    ,htclObjToDouble
    ,htclObjToString
    ,htclObjToList
    -- composite
    ,htclObjToListInt
    ,htclObjToListDouble
    ,htclObjToListString
    -------------------------------
    ,HTclObj(..)
    -- Conversion to from objects to fields of this type
    ,HTclObjCvt(..)
    ,tag
    ,tagStr
    ,tagInt
    ,tagLst
    ,tagManyStr
    ,tagManyInt
    ,joinHTObj
    ,joinHTObjs
    -----------------
    -- Grammar combinators
    , kw
    , tclcmd
    , arg
    , (.+.)
    , oneOf
    , optional
    , atLeast
    -----------------
    -- Tests and Experiments
    )
where

import Prelude

import Data.Word

import Foreign.Storable
import Foreign.Marshal.Alloc
import Foreign.Marshal.Array
import Foreign.Marshal.Utils
import Foreign.Ptr
import Foreign.C.Types
import Foreign.C.String
import Data.Time.Clock
import Data.Time.Clock.POSIX

import Foreign.ForeignPtr
import Foreign.ForeignPtr.Unsafe(unsafeForeignPtrToPtr)

import Control.Monad(foldM, mplus, msum, when)
import System.IO.Error
import System.Exit(ExitCode(..))
import Data.List(intersperse, nub, isPrefixOf)

import qualified Control.Exception as CE

--import Debug.Trace
traceCalls :: Bool
traceCalls = False


-- cast function
castE :: (Enum a, Enum b) => a -> b
castE = toEnum . fromEnum

castI :: (Integral a, Integral b) => a -> b
castI = fromIntegral

castD :: (RealFloat a, RealFloat b) => a -> b
castD = (uncurry encodeFloat) . decodeFloat

--------------------------------------------------------------------------------
-- Common TCL function status
-- Note break, continue are not (yet) defined


-- | Status of a TCL command
data TclStatus = TclOK | TclError
    deriving (Eq, Show, Enum)

tclOK :: TclStatus
tclOK = TclOK

tclError :: TclStatus
tclError = TclError

-- Get real values from tcl world -- there should be an easier way to do this for #defines!
foreign import capi "tcl.h value TCL_OK"
 htcl_OKc :: CInt
foreign import capi "tcl.h value TCL_ERROR"
 htcl_Errorc :: CInt


-- exported versions of tcl status using native haskell types
htcl_OK :: TclStatus
htcl_OK = TclOK

htcl_Error :: TclStatus
htcl_Error = TclError


--------------------------------------------------------------------------------

-- The interperter -- no need for a finalizer call here
data XTclInterp = XTclInterp
type TclInterp = Ptr XTclInterp

-- Client data structure
type TclClientData = Ptr Int


-- Types and functions to deal with     Tcl Objects
-- Wrapper for foreign (tcl objects)
-- Objects which are passed to and from commands
data {-# CTYPE "Tcl_Obj" #-} XTclObj = XTclObj
type PTclObj = Ptr XTclObj
type TclObj = ForeignPtr XTclObj
type PTclObjArray = Ptr PTclObj


-- Foreign import functions --     Objects
foreign import ccall "Tcl_NewIntObj"
 tcl_NewIntObj :: CInt -> IO (PTclObj)

foreign import ccall "Tcl_NewWideIntObj"
 tcl_NewWideIntObj :: CLLong -> IO (PTclObj) -- tcl uses long long

foreign import ccall "Tcl_NewDoubleObj"
 tcl_NewDoubleObj :: CDouble -> IO PTclObj -- tcl double

foreign import ccall "Tcl_NewStringObj"
 tcl_NewStringObj :: Ptr CChar -> CInt -> IO PTclObj

foreign import ccall "Tcl_NewListObj"
 tcl_NewListObj :: CInt -> Ptr PTclObj ->  IO PTclObj


---------------------------------------------------------------
-- Reference count on Objects
foreign import capi "tcl.h Tcl_DecrRefCount"
 tcl_DecrRefCount :: PTclObj -> IO ()

foreign import capi "tcl.h Tcl_IncrRefCount"
 tcl_IncrRefCount :: PTclObj -> IO ()

foreign import ccall "&htcl_finalizeTclObj"
  tcl_finalizeTclObj :: FunPtr (PTclObj -> IO ())

tclObjFinalizer :: FinalizerPtr XTclObj
tclObjFinalizer = tcl_finalizeTclObj

-- Function to wrap tcl object into finalizer
wrapPtrForExport :: PTclObj -> IO TclObj
wrapPtrForExport pobj = do
  tcl_IncrRefCount pobj
  fp <- newForeignPtr_  pobj
  addForeignPtrFinalizer tclObjFinalizer fp
  return fp

---------------------------------------------------------
-- A class to provide means to convert to tcl objects and
-- haskell objects
-- 2 members are defined, one to convert to Ptr XTclObj and the other to convert to
-- ForeignPtr XTclObj.  Only the later should be used externally
class TclObjCvt a  where
    toTclObj    :: a -> IO TclObj


-- an instance of TclObjCvt call for Unit
instance  TclObjCvt () where
    toTclObj i  = toTclObj ""

-- an instance of TclObjCvt call for Bool
instance  TclObjCvt Bool where
    toTclObj b  = tcl_NewIntObj (if b then 1 else 0) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Int
instance  TclObjCvt Int where
    toTclObj i  = tcl_NewIntObj (castI i) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Integer
-- use show since value can be greater than native representation
instance  TclObjCvt Integer where
    toTclObj i  = toTclObj (show i)



































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































{-# LANGUAGE CPP, ForeignFunctionInterface, CApiFFI #-}
{-# LANGUAGE TypeSynonymInstances, FlexibleInstances #-}
{-# OPTIONS_GHC -Wall -fno-warn-unused-binds -fno-warn-unused-matches -Werror #-}

-- User level Haskell interface for TCL
-- Users of this module should not need to understand the tcl
-- implementation underneath this module
--
-- Ed Czeck, Bluespec Inc
-- April 2007


{-
  TODO
   - I do not like the error handling, via the Maybe type, but some may not want to throw errors
   - options processing (getOptions :: TclInterp -> [TclObj] -> [OptionDesc a] -> IO (a, [TclObj])
   - add import for Tcl_Eval
-}

module HTcl
    (
     -- Status return values, and an enum
     htcl_OK
    ,htcl_Error
    ,TclStatus

    ,TclObjCvt(..)
    ,TclInterp
    ,TclObj
    -----------------------
    -- Registering command and other command
    --  Types for command objects
    ,TclObjCmdProc
    ,TclCmdDeleteProc
    ,TclClientData
    ,htclRawFnToTclCmd
    ,htclFnToTclCmd
    ,htclCheckCmd
    ,htclMakeCmdDesc
    ,HTclCmdDesc(..)
    ,HTclCmdElem(..)
    ,HTclArgType(..)
    ,HTclCmdGrammar(..)
    ,HTclCmdFn
    ,HTclCheckedCmdFn
    ,htclRegisterCommand
    ,htclRegisterCommandFull
    ,htclRegCommands
    ,htclCmdName
    ,htclFirstCmdElem
    ,htclDescribeCmdGrammar
    ,htclGrammarShortDesc
    ,htclMatchGrammar
    ,htclCanMatchNull
    ,htclSetReturnVal           -- may not be needed
    -- Dealing with Errors
    ,htcl_AddObjErrorInfo
    ,htclErrorCatcher
    -------------------------------
    -- Converting from Obj to Native Haskell types
    ,htclArgsToTcl
    -- primitives
    ,htclObjToInt
    ,htclObjToBool
    ,htclObjToDouble
    ,htclObjToString
    ,htclObjToList
    -- composite
    ,htclObjToListInt
    ,htclObjToListDouble
    ,htclObjToListString
    -------------------------------
    ,HTclObj(..)
    -- Conversion to from objects to fields of this type
    ,HTclObjCvt(..)
    ,tag
    ,tagStr
    ,tagInt
    ,tagLst
    ,tagManyStr
    ,tagManyInt
    ,joinHTObj
    ,joinHTObjs
    -----------------
    -- Grammar combinators
    , kw
    , tclcmd
    , arg
    , (.+.)
    , oneOf
    , optional
    , atLeast
    -----------------
    -- Tests and Experiments
    )
where

import Prelude

import Data.Word

import Foreign.Storable
import Foreign.Marshal.Alloc
import Foreign.Marshal.Array
import Foreign.Marshal.Utils
import Foreign.Ptr
import Foreign.C.Types
import Foreign.C.String
import Data.Time.Clock
import Data.Time.Clock.POSIX

import Foreign.ForeignPtr
import Foreign.ForeignPtr.Unsafe(unsafeForeignPtrToPtr)

import Control.Monad(foldM, mplus, msum, when)
import System.IO.Error
import System.Exit(ExitCode(..))
import Data.List(intersperse, nub, isPrefixOf)

import qualified Control.Exception as CE

--import Debug.Trace
traceCalls :: Bool
traceCalls = False


-- cast function
castE :: (Enum a, Enum b) => a -> b
castE = toEnum . fromEnum

castI :: (Integral a, Integral b) => a -> b
castI = fromIntegral

castD :: (RealFloat a, RealFloat b) => a -> b
castD = (uncurry encodeFloat) . decodeFloat

--------------------------------------------------------------------------------
-- Common TCL function status
-- Note break, continue are not (yet) defined


-- | Status of a TCL command
data TclStatus = TclOK | TclError
    deriving (Eq, Show, Enum)

tclOK :: TclStatus
tclOK = TclOK

tclError :: TclStatus
tclError = TclError

-- Get real values from tcl world -- there should be an easier way to do this for #defines!
foreign import capi "tcl.h value TCL_OK"
 htcl_OKc :: CInt
foreign import capi "tcl.h value TCL_ERROR"
 htcl_Errorc :: CInt


-- exported versions of tcl status using native haskell types
htcl_OK :: TclStatus
htcl_OK = TclOK

htcl_Error :: TclStatus
htcl_Error = TclError


--------------------------------------------------------------------------------

-- The interperter -- no need for a finalizer call here
data XTclInterp = XTclInterp
type TclInterp = Ptr XTclInterp

-- Client data structure
type TclClientData = Ptr Int


-- Types and functions to deal with     Tcl Objects
-- Wrapper for foreign (tcl objects)
-- Objects which are passed to and from commands
data {-# CTYPE "Tcl_Obj" #-} XTclObj = XTclObj
type PTclObj = Ptr XTclObj
type TclObj = ForeignPtr XTclObj
type PTclObjArray = Ptr PTclObj


-- Foreign import functions --     Objects
foreign import ccall "Tcl_NewIntObj"
 tcl_NewIntObj :: CInt -> IO (PTclObj)

foreign import ccall "Tcl_NewWideIntObj"
 tcl_NewWideIntObj :: CLLong -> IO (PTclObj) -- tcl uses long long

foreign import ccall "Tcl_NewDoubleObj"
 tcl_NewDoubleObj :: CDouble -> IO PTclObj -- tcl double

foreign import ccall "Tcl_NewStringObj"
 tcl_NewStringObj :: Ptr CChar -> CInt -> IO PTclObj

foreign import ccall "Tcl_NewListObj"
 tcl_NewListObj :: CInt -> Ptr PTclObj ->  IO PTclObj


---------------------------------------------------------------
-- Reference count on Objects
foreign import capi "tcl.h Tcl_DecrRefCount"
 tcl_DecrRefCount :: PTclObj -> IO ()

foreign import capi "tcl.h Tcl_IncrRefCount"
 tcl_IncrRefCount :: PTclObj -> IO ()

foreign import ccall "&htcl_finalizeTclObj"
  tcl_finalizeTclObj :: FunPtr (PTclObj -> IO ())

tclObjFinalizer :: FinalizerPtr XTclObj
tclObjFinalizer = tcl_finalizeTclObj

-- Function to wrap tcl object into finalizer
wrapPtrForExport :: PTclObj -> IO TclObj
wrapPtrForExport pobj = do
  tcl_IncrRefCount pobj
  fp <- newForeignPtr_  pobj
  addForeignPtrFinalizer tclObjFinalizer fp
  return fp

---------------------------------------------------------
-- A class to provide means to convert to tcl objects and
-- haskell objects
-- 2 members are defined, one to convert to Ptr XTclObj and the other to convert to
-- ForeignPtr XTclObj.  Only the later should be used externally
class TclObjCvt a  where
    toTclObj    :: a -> IO TclObj


-- an instance of TclObjCvt call for Unit
instance  TclObjCvt () where
    toTclObj i  = toTclObj ""

-- an instance of TclObjCvt call for Bool
instance  TclObjCvt Bool where
    toTclObj b  = tcl_NewIntObj (if b then 1 else 0) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Int
instance  TclObjCvt Int where
    toTclObj i  = tcl_NewIntObj (castI i) >>= wrapPtrForExport

-- an instance of TclObjCvt call for Integer
-- use show since value can be greater than native representation
instance  TclObjCvt Integer where
    toTclObj i  = toTclObj (show i)



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































htcl_Error = TclError 